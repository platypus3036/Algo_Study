name: Generate Daily Study Template

on:
  workflow_dispatch:
    inputs:
      date:
        description: '폴더 이름으로 사용할 날짜 (yymmdd 형식)'
        required: true
      problems:
        description: '문제와 링크 목록 (형식: 문제이름1:링크1,문제이름2:링크2)'
        required: true
        default: '문제A:https://example.com/problem/1,문제B:https://example.com/problem/2'

jobs:
  generate-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create study template
        run: |
          TARGET_DATE="${{ github.event.inputs.date }}"
          PROBLEM_LIST="${{ github.event.inputs.problems }}"
          
          mkdir -p "$TARGET_DATE"
          
          # README 파일의 상단 부분을 변수에 저장합니다.
          README_CONTENT=$(cat <<-EOF
          # 🗓️ ${TARGET_DATE} 스터디 회고

          ## 🎯 이번 주 스터디 목표 및 주요 학습 내용
          - 

          ---

          ## 📚 문제별 토론 및 회고
          EOF
          )

          # 입력받은 문제 목록을 쉼표(,)를 기준으로 분리합니다.
          IFS=',' read -ra PROBLEMS_ARRAY <<< "$PROBLEM_LIST"

          # 각 문제에 대한 섹션을 반복하여 추가하고, 문제별 폴더를 생성합니다.
          for item in "${PROBLEMS_ARRAY[@]}"; do
            PROBLEM_NAME="${item%%:*}"
            PROBLEM_LINK="${item#*:}"
            
            # 문제 이름 앞뒤의 공백을 제거합니다.
            PROBLEM_NAME=$(echo "$PROBLEM_NAME" | sed 's/^[ \t]*//;s/[ \t]*$//')

            # 각 문제 이름으로 폴더를 생성합니다. (수정된 부분)
            mkdir -p "${TARGET_DATE}/${PROBLEM_NAME}"
            
            README_CONTENT+=$(cat <<-EOM

          ### 📝 ${PROBLEM_NAME}
          - **문제 링크**: [바로가기](${PROBLEM_LINK})
          - **난이도**: 
          - **주요 접근법 요약**: 
          - **토론 내용 및 피드백**: 
          EOM
          )
          done

          # KPT 회고 및 다음 주 계획 섹션을 추가합니다.
          README_CONTENT+=$(cat <<-EOF

          ---

          ## 🚀 KPT 회고 (Keep, Problem, Try)
          ### Keep (유지할 점)
          - 

          ### Problem (개선할 점)
          - 

          ### Try (다음에 시도할 점)
          - 

          ---

          ## 🗓️ 다음 주 계획
          - 
          EOF
          )

          # 완성된 내용을 파일에 한 번에 씁니다.
          echo "$README_CONTENT" > "${TARGET_DATE}/README.md"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          
          # 변경된 파일이 있을 경우에만 커밋과 푸시를 진행합니다.
          if ! git diff-index --quiet HEAD; then
            git commit -m "docs: Create study retrospective template for ${TARGET_DATE}"
            git push
          else
            echo "No changes to commit."
          fi
